<svg viewBox="0 0 1400 600" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles -->
  <defs>
    <style>
      .bg { fill: #37505C; }
      .box { fill: none; stroke: #7FA7B8; stroke-width: 2; }
      .circle { fill: none; stroke: #7FA7B8; stroke-width: 3; }
      .icon-circle { fill: #5A7A8A; stroke: #7FA7B8; stroke-width: 2; }
      .text-white { fill: #E8F1F5; font-family: 'Segoe UI', Arial, sans-serif; font-size: 16px; text-anchor: middle; }
      .text-small { fill: #B8CDD8; font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; text-anchor: middle; }
      .text-tiny { fill: #8FAAB8; font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; text-anchor: middle; }
      .arrow { stroke: #7FA7B8; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-back { stroke: #7FA7B8; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 4,4; }
    </style>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#7FA7B8" />
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="1400" height="600" class="bg"/>
  
  <!-- Title -->
  <text x="40" y="45" class="text-white" style="font-size: 16px; font-weight: 600; text-anchor: start;">
    Query from query.txt + Optional Date Filter (YYYY/MM/DD)
  </text>
  
  <!-- User Icon -->
  <circle cx="40" cy="100" r="18" class="icon-circle"/>
  <circle cx="40" cy="92" r="7" fill="#7FA7B8"/>
  <path d="M 28 105 Q 28 115 40 115 Q 52 115 52 105" fill="#7FA7B8"/>
  <text x="40" y="145" class="text-small">main()</text>
  
  <!-- Arrow from user -->
  <line x1="60" y1="100" x2="110" y2="100" class="arrow"/>
  
  <!-- 1. Read query.txt -->
  <rect x="110" y="70" width="120" height="60" rx="3" class="box"/>
  <text x="170" y="93" class="text-white" style="font-weight: 600;">1. Read Query</text>
  <text x="170" y="110" class="text-small">query.txt</text>
  <text x="170" y="145" class="text-tiny">File I/O</text>
  
  <!-- Arrow -->
  <line x1="230" y1="100" x2="270" y2="100" class="arrow"/>
  
  <!-- 2. Build Query String -->
  <rect x="270" y="70" width="120" height="60" rx="3" class="box"/>
  <text x="330" y="88" class="text-white" style="font-weight: 600;">2. Build Query</text>
  <text x="330" y="105" class="text-small">+ Date Filter</text>
  <text x="330" y="118" class="text-tiny">[PDAT]</text>
  <text x="330" y="145" class="text-tiny">fetch_all_pubmed_data()</text>
  
  <!-- Arrow -->
  <line x1="390" y1="100" x2="430" y2="100" class="arrow"/>
  
  <!-- 3. ESearch API - Get PMIDs -->
  <rect x="430" y="65" width="140" height="70" rx="3" class="box"/>
  <text x="500" y="88" class="text-white" style="font-weight: 600;">3. ESearch API</text>
  <text x="500" y="105" class="text-small">Get PMIDs</text>
  <text x="500" y="120" class="text-tiny">esearch.fcgi</text>
  <text x="500" y="150" class="text-tiny">retmax=200, sort=relevance</text>
  
  <!-- Arrow -->
  <line x1="570" y1="100" x2="610" y2="100" class="arrow"/>
  
  <!-- Pagination Loop Circle -->
  <circle cx="670" cy="100" r="50" class="circle"/>
  <text x="670" y="95" class="text-white" style="font-weight: 600; font-size: 13px;">Pagination</text>
  <text x="670" y="110" class="text-white" style="font-weight: 600; font-size: 13px;">Loop</text>
  <text x="670" y="125" class="text-tiny">retstart += 200</text>
  
  <!-- Loop back arrow from pagination -->
  <path d="M 670 50 L 670 20 L 500 20 L 500 65" class="arrow-back"/>
  <text x="585" y="15" class="text-tiny">More PMIDs? Yes → Continue</text>
  
  <!-- Arrow from pagination -->
  <line x1="720" y1="100" x2="760" y2="100" class="arrow"/>
  
  <!-- 4. Parse XML PMIDs -->
  <rect x="760" y="70" width="110" height="60" rx="3" class="box"/>
  <text x="815" y="93" class="text-white" style="font-weight: 600;">4. Parse XML</text>
  <text x="815" y="110" class="text-small">Extract PMIDs</text>
  <text x="815" y="145" class="text-tiny">lxml.etree</text>
  
  <!-- Arrow -->
  <line x1="870" y1="100" x2="910" y2="100" class="arrow"/>
  
  <!-- 5. EFetch API -->
  <rect x="910" y="65" width="140" height="70" rx="3" class="box"/>
  <text x="980" y="88" class="text-white" style="font-weight: 600;">5. EFetch API</text>
  <text x="980" y="105" class="text-small">Get Article Data</text>
  <text x="980" y="120" class="text-tiny">efetch.fcgi</text>
  <text x="980" y="150" class="text-tiny">batch=200 PMIDs</text>
  
  <!-- Arrow down to processing -->
  <line x1="980" y1="135" x2="980" y2="180" class="arrow"/>
  
  <!-- Processing Row -->
  <g transform="translate(0, 180)">
    
    <!-- 6. Parse Article XML -->
    <rect x="200" y="40" width="130" height="65" rx="3" class="box"/>
    <text x="265" y="60" class="text-white" style="font-size: 12px; font-weight: 600;">6. Parse Article XML</text>
    <text x="265" y="77" class="text-small" style="font-size: 10px;">Extract 17 Fields:</text>
    <text x="265" y="91" class="text-tiny">PMID, Title, Authors,</text>
    <text x="265" y="101" class="text-tiny">Abstract, DOI, etc.</text>
    
    <!-- Arrow -->
    <line x1="330" y1="72" x2="365" y2="72" class="arrow"/>
    
    <!-- 7. Clean HTML -->
    <rect x="365" y="50" width="110" height="45" rx="3" class="box"/>
    <text x="420" y="68" class="text-white" style="font-size: 11px;">7. Clean HTML</text>
    <text x="420" y="83" class="text-small" style="font-size: 10px;">BeautifulSoup</text>
    <text x="420" y="110" class="text-tiny">clean_html()</text>
    
    <!-- Arrow -->
    <line x1="475" y1="72" x2="510" y2="72" class="arrow"/>
    
    <!-- 8. Format Data -->
    <rect x="510" y="50" width="110" height="45" rx="3" class="box"/>
    <text x="565" y="68" class="text-white" style="font-size: 11px;">8. Format Data</text>
    <text x="565" y="83" class="text-small" style="font-size: 10px;">UTF-8 Encode</text>
    <text x="565" y="110" class="text-tiny">Text normalization</text>
    
    <!-- Arrow -->
    <line x1="620" y1="72" x2="655" y2="72" class="arrow"/>
    
    <!-- 9. Build Dictionary -->
    <rect x="655" y="50" width="110" height="45" rx="3" class="box"/>
    <text x="710" y="68" class="text-white" style="font-size: 11px;">9. Build Dict</text>
    <text x="710" y="83" class="text-small" style="font-size: 10px;">Article Record</text>
    <text x="710" y="110" class="text-tiny">results.append()</text>
    
    <!-- Arrow -->
    <line x1="765" y1="72" x2="805" y2="72" class="arrow"/>
    
    <!-- Hexagon for aggregation -->
    <path d="M 805 72 L 825 52 L 865 52 L 885 72 L 865 92 L 825 92 Z" class="box" style="fill: #4A6572;"/>
    <text x="845" y="78" class="text-white" style="font-size: 10px;">List</text>
    
    <!-- Arrow -->
    <line x1="885" y1="72" x2="920" y2="72" class="arrow"/>
    
    <!-- Batch Loop Circle -->
    <circle cx="980" cy="72" r="40" class="circle"/>
    <text x="980" y="68" class="text-white" style="font-weight: 600; font-size: 12px;">Batch</text>
    <text x="980" y="82" class="text-white" style="font-weight: 600; font-size: 12px;">Loop</text>
    <text x="980" y="105" class="text-tiny">200/batch</text>
    
    <!-- Loop back from batch -->
    <path d="M 980 32 L 980 0 L 980 -135 L 910 -135" class="arrow-back"/>
    <text x="945" y="-125" class="text-tiny">More batches? Yes</text>
  </g>
  
  <!-- Arrow after all batches processed -->
  <line x1="1020" y1="252" x2="1060" y2="252" class="arrow"/>
  
  <!-- 10. Save to CSV -->
  <g transform="translate(1060, 217)">
    <rect x="0" y="0" width="130" height="70" rx="3" class="box"/>
    <text x="65" y="25" class="text-white" style="font-weight: 600;">10. Save to CSV</text>
    <text x="65" y="42" class="text-small" style="font-size: 10px;">Data/pubmed.csv</text>
    <text x="65" y="56" class="text-tiny">UTF-8-SIG</text>
    <text x="65" y="85" class="text-tiny">save_to_csv()</text>
    
    <!-- CSV Icon -->
    <rect x="25" y="30" width="25" height="30" rx="2" fill="none" stroke="#7FA7B8" stroke-width="1.5"/>
    <line x1="28" y1="38" x2="47" y2="38" stroke="#7FA7B8" stroke-width="1"/>
    <line x1="28" y1="44" x2="47" y2="44" stroke="#7FA7B8" stroke-width="1"/>
    <line x1="28" y1="50" x2="47" y2="50" stroke="#7FA7B8" stroke-width="1"/>
  </g>
  
  <!-- Arrow to end -->
  <line x1="1190" y1="252" x2="1230" y2="252" class="arrow"/>
  
  <!-- Output file icon -->
  <g transform="translate(1230, 217)">
    <rect x="0" y="0" width="60" height="70" rx="3" class="box" style="fill: #4A6572;"/>
    <path d="M 40 0 L 60 20 L 40 20 Z" fill="#37505C" stroke="#7FA7B8" stroke-width="2"/>
    <line x1="10" y1="35" x2="50" y2="35" stroke="#7FA7B8" stroke-width="1.5"/>
    <line x1="10" y1="45" x2="50" y2="45" stroke="#7FA7B8" stroke-width="1.5"/>
    <line x1="10" y1="55" x2="40" y2="55" stroke="#7FA7B8" stroke-width="1.5"/>
    
    <text x="80" y="25" class="text-white" style="font-size: 12px; text-anchor: start;">pubmed.csv</text>
    <text x="80" y="42" class="text-small" style="font-size: 10px; text-anchor: start;">Ready for Analysis</text>
  </g>
  
  <!-- Function call annotations -->
  <g transform="translate(50, 380)">
    <text x="0" y="0" class="text-white" style="font-size: 13px; text-anchor: start; font-weight: 600;">Key Functions:</text>
    <text x="0" y="20" class="text-small" style="font-size: 11px; text-anchor: start;">
      • main() - Entry point, handles user input and orchestrates pipeline
    </text>
    <text x="0" y="38" class="text-small" style="font-size: 11px; text-anchor: start;">
      • fetch_all_pubmed_data(query, start_date, end_date) - Main data fetching logic
    </text>
    <text x="0" y="56" class="text-small" style="font-size: 11px; text-anchor: start;">
      • clean_html(raw_html) - Remove HTML tags using BeautifulSoup
    </text>
    <text x="0" y="74" class="text-small" style="font-size: 11px; text-anchor: start;">
      • save_to_csv(data, filename) - Write results to CSV with UTF-8-SIG encoding
    </text>
  </g>
  
  <!-- Extracted fields info -->
  <g transform="translate(50, 480)">
    <text x="0" y="0" class="text-white" style="font-size: 13px; text-anchor: start; font-weight: 600;">17 Extracted Fields per Article:</text>
    <text x="0" y="20" class="text-small" style="font-size: 11px; text-anchor: start;">
      PMID • Title • Authors • Abstract • DOI • Journal • PublicationDate • Volume • Issue • Pages
    </text>
    <text x="0" y="38" class="text-small" style="font-size: 11px; text-anchor: start;">
      PublicationType • Keywords • PMC_ID • MeSH_Terms • GrantInfo • Language • ISSN
    </text>
  </g>
  
  <!-- Tech stack -->
  <g transform="translate(50, 550)">
    <text x="0" y="0" class="text-white" style="font-size: 13px; text-anchor: start; font-weight: 600;">Libraries:</text>
    <text x="0" y="20" class="text-small" style="font-size: 11px; text-anchor: start;">
      requests • lxml (etree) • BeautifulSoup4 • csv • os
    </text>
  </g>
  
  <!-- Stats box -->
  <g transform="translate(1000, 380)">
    <rect x="0" y="0" width="350" height="175" rx="3" class="box" style="fill: #2C3E47;"/>
    <text x="175" y="25" class="text-white" style="font-size: 13px; font-weight: 600;">Pipeline Configuration</text>
    
    <text x="20" y="55" class="text-small" style="font-size: 11px; text-anchor: start; font-weight: 600;">API Endpoints:</text>
    <text x="20" y="73" class="text-small" style="font-size: 10px; text-anchor: start;">• ESearch: esearch.fcgi (PMID retrieval)</text>
    <text x="20" y="88" class="text-small" style="font-size: 10px; text-anchor: start;">• EFetch: efetch.fcgi (Full article metadata)</text>
    
    <text x="20" y="113" class="text-small" style="font-size: 11px; text-anchor: start; font-weight: 600;">Processing:</text>
    <text x="20" y="131" class="text-small" style="font-size: 10px; text-anchor: start;">• Batch Size: 200 PMIDs/request</text>
    <text x="20" y="146" class="text-small" style="font-size: 10px; text-anchor: start;">• Sort Order: Best Match (relevance)</text>
    <text x="20" y="161" class="text-small" style="font-size: 10px; text-anchor: start;">• Output: Data/pubmed.csv (UTF-8-SIG)</text>
  </g>
</svg>