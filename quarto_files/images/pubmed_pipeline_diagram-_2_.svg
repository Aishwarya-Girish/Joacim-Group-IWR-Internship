<svg viewBox="0 0 1600 700" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles -->
  <defs>
    <style>
      .bg { fill: #37505C; }
      .box { fill: none; stroke: #7FA7B8; stroke-width: 2; }
      .circle { fill: none; stroke: #7FA7B8; stroke-width: 3; }
      .icon-circle { fill: #5A7A8A; stroke: #7FA7B8; stroke-width: 2; }
      .text-white { fill: #E8F1F5; font-family: 'Segoe UI', Arial, sans-serif; font-size: 18px; text-anchor: middle; }
      .text-small { fill: #B8CDD8; font-family: 'Segoe UI', Arial, sans-serif; font-size: 15px; text-anchor: middle; }
      .text-tiny { fill: #8FAAB8; font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; text-anchor: middle; }
      .arrow { stroke: #7FA7B8; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-back { stroke: #7FA7B8; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 4,4; }
    </style>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#7FA7B8" />
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="1600" height="700" class="bg"/>
  
  <!-- Title -->
  <text x="40" y="45" class="text-white" style="font-size: 18px; font-weight: 600; text-anchor: start;">
    Query from query.txt + Optional Date Filter (YYYY/MM/DD)
  </text>
  
  <!-- User Icon -->
  <circle cx="40" cy="120" r="18" class="icon-circle"/>
  <circle cx="40" cy="112" r="7" fill="#7FA7B8"/>
  <path d="M 28 125 Q 28 135 40 135 Q 52 135 52 125" fill="#7FA7B8"/>
  <text x="40" y="165" class="text-small">main()</text>
  
  <!-- Arrow from user -->
  <line x1="60" y1="120" x2="120" y2="120" class="arrow"/>
  
  <!-- 1. Read query.txt -->
  <rect x="120" y="85" width="150" height="70" rx="5" class="box"/>
  <text x="195" y="115" class="text-white" style="font-weight: 600;">1. Read Query</text>
  <text x="195" y="135" class="text-small">query.txt</text>
  <text x="195" y="175" class="text-tiny">File I/O</text>
  
  <!-- Arrow -->
  <line x1="270" y1="120" x2="330" y2="120" class="arrow"/>
  
  <!-- 2. Build Query String -->
  <rect x="330" y="85" width="150" height="70" rx="5" class="box"/>
  <text x="405" y="110" class="text-white" style="font-weight: 600;">2. Build Query</text>
  <text x="405" y="130" class="text-small">+ Date Filter</text>
  <text x="405" y="147" class="text-tiny">[PDAT]</text>
  <text x="405" y="180" class="text-tiny">fetch_all_pubmed_data()</text>
  
  <!-- Arrow -->
  <line x1="480" y1="120" x2="540" y2="120" class="arrow"/>
  
  <!-- 3. ESearch API - Get PMIDs -->
  <rect x="540" y="75" width="160" height="90" rx="5" class="box"/>
  <text x="620" y="108" class="text-white" style="font-weight: 600;">3. ESearch API</text>
  <text x="620" y="128" class="text-small">Get PMIDs</text>
  <text x="620" y="146" class="text-tiny">esearch.fcgi</text>
  <text x="620" y="183" class="text-tiny">retmax=200, sort=relevance</text>
  
  <!-- Arrow -->
  <line x1="700" y1="120" x2="760" y2="120" class="arrow"/>
  
  <!-- Pagination Loop Circle -->
  <circle cx="830" cy="120" r="55" class="circle"/>
  <text x="830" y="112" class="text-white" style="font-weight: 600; font-size: 16px;">Pagination</text>
  <text x="830" y="132" class="text-white" style="font-weight: 600; font-size: 16px;">Loop</text>
  <text x="830" y="155" class="text-tiny">retstart += 200</text>
  
  <!-- Loop back arrow from pagination -->
  <path d="M 830 65 L 830 30 L 620 30 L 620 75" class="arrow-back"/>
  <text x="725" y="20" class="text-tiny">More PMIDs? Yes → Continue</text>
  
  <!-- Arrow from pagination -->
  <line x1="885" y1="120" x2="950" y2="120" class="arrow"/>
  
  <!-- 4. Parse XML PMIDs -->
  <rect x="950" y="85" width="130" height="70" rx="5" class="box"/>
  <text x="1015" y="115" class="text-white" style="font-weight: 600;">4. Parse XML</text>
  <text x="1015" y="135" class="text-small">Extract PMIDs</text>
  <text x="1015" y="175" class="text-tiny">lxml.etree</text>
  
  <!-- Arrow -->
  <line x1="1080" y1="120" x2="1150" y2="120" class="arrow"/>
  
  <!-- 5. EFetch API -->
  <rect x="1150" y="75" width="160" height="90" rx="5" class="box"/>
  <text x="1230" y="105" class="text-white" style="font-weight: 600;">5. EFetch API</text>
  <text x="1230" y="125" class="text-small">Get Article Data</text>
  <text x="1230" y="143" class="text-tiny">efetch.fcgi</text>
  <text x="1230" y="183" class="text-tiny">batch=200 PMIDs</text>
  
  <!-- Arrow down to processing -->
  <line x1="1230" y1="165" x2="1230" y2="220" class="arrow"/>
  
  <!-- Processing Row -->
  <g transform="translate(0, 220)">
    
    <!-- 6. Parse Article XML -->
    <rect x="240" y="30" width="150" height="90" rx="5" class="box"/>
    <text x="315" y="60" class="text-white" style="font-size: 16px; font-weight: 600;">6. Parse Article XML</text>
    <text x="315" y="82" class="text-small" style="font-size: 13px;">Extract 17 Fields:</text>
    <text x="315" y="100" class="text-tiny">PMID, Title, Authors,</text>
    <text x="315" y="115" class="text-tiny">Abstract, DOI, etc.</text>
    
    <!-- Arrow -->
    <line x1="390" y1="75" x2="440" y2="75" class="arrow"/>
    
    <!-- 7. Clean HTML -->
    <rect x="440" y="45" width="130" height="60" rx="5" class="box"/>
    <text x="505" y="70" class="text-white" style="font-size: 14px;">7. Clean HTML</text>
    <text x="505" y="90" class="text-small" style="font-size: 13px;">BeautifulSoup</text>
    <text x="505" y="125" class="text-tiny">clean_html()</text>
    
    <!-- Arrow -->
    <line x1="570" y1="75" x2="620" y2="75" class="arrow"/>
    
    <!-- 8. Format Data -->
    <rect x="620" y="45" width="130" height="60" rx="5" class="box"/>
    <text x="685" y="70" class="text-white" style="font-size: 14px;">8. Format Data</text>
    <text x="685" y="90" class="text-small" style="font-size: 13px;">UTF-8 Encode</text>
    <text x="685" y="125" class="text-tiny">Text normalization</text>
    
    <!-- Arrow -->
    <line x1="750" y1="75" x2="800" y2="75" class="arrow"/>
    
    <!-- 9. Build Dictionary -->
    <rect x="800" y="45" width="130" height="60" rx="5" class="box"/>
    <text x="865" y="70" class="text-white" style="font-size: 14px;">9. Build Dict</text>
    <text x="865" y="90" class="text-small" style="font-size: 13px;">Article Record</text>
    <text x="865" y="125" class="text-tiny">results.append()</text>
    
    <!-- Arrow -->
    <line x1="930" y1="75" x2="985" y2="75" class="arrow"/>
    
    <!-- Hexagon for aggregation -->
    <path d="M 985 75 L 1010 50 L 1060 50 L 1085 75 L 1060 100 L 1010 100 Z" class="box" style="fill: #4A6572;"/>
    <text x="1035" y="82" class="text-white" style="font-size: 14px;">List</text>
    
    <!-- Arrow -->
    <line x1="1085" y1="75" x2="1140" y2="75" class="arrow"/>
    
    <!-- Batch Loop Circle -->
    <circle cx="1210" cy="75" r="50" class="circle"/>
    <text x="1210" y="68" class="text-white" style="font-weight: 600; font-size: 14px;">Batch</text>
    <text x="1210" y="86" class="text-white" style="font-weight: 600; font-size: 14px;">Loop</text>
    <text x="1210" y="115" class="text-tiny">200/batch</text>
    
    <!-- Loop back from batch -->
    <path d="M 1210 25 L 1210 -15 L 1230 -15 L 1230 -55" class="arrow-back"/>
    <text x="1320" y="-5" class="text-tiny">More batches? Yes</text>
  </g>
  
  <!-- Arrow after all batches processed -->
  <line x1="1260" y1="295" x2="1310" y2="295" class="arrow"/>
  
  <!-- 10. Save to CSV -->
  <g transform="translate(1320, 250)">
    <rect x="0" y="0" width="150" height="90" rx="5" class="box"/>
    <text x="75" y="35" class="text-white" style="font-weight: 600;">10. Save to CSV</text>
    <text x="75" y="57" class="text-small" style="font-size: 13px;">Data/pubmed.csv</text>
    <text x="75" y="75" class="text-tiny">UTF-8-SIG</text>
    <text x="75" y="110" class="text-tiny">save_to_csv()</text>
  </g>
  
  <!-- Function call annotations -->
  <g transform="translate(50, 420)">
    <text x="0" y="0" class="text-white" style="font-size: 16px; text-anchor: start; font-weight: 600;">Key Functions:</text>
    <text x="0" y="28" class="text-small" style="font-size: 13px; text-anchor: start;">
      • main() - Entry point, handles user input and orchestrates pipeline
    </text>
    <text x="0" y="52" class="text-small" style="font-size: 13px; text-anchor: start;">
      • fetch_all_pubmed_data(query, start_date, end_date) - Main data fetching logic
    </text>
    <text x="0" y="76" class="text-small" style="font-size: 13px; text-anchor: start;">
      • clean_html(raw_html) - Remove HTML tags using BeautifulSoup
    </text>
    <text x="0" y="100" class="text-small" style="font-size: 13px; text-anchor: start;">
      • save_to_csv(data, filename) - Write results to CSV with UTF-8-SIG encoding
    </text>
  </g>
  
  <!-- Extracted fields info -->
  <g transform="translate(50, 550)">
    <text x="0" y="0" class="text-white" style="font-size: 16px; text-anchor: start; font-weight: 600;">17 Extracted Fields per Article:</text>
    <text x="0" y="28" class="text-small" style="font-size: 13px; text-anchor: start;">
      PMID • Title • Authors • Abstract • DOI • Journal • PublicationDate • Volume • Issue • Pages
    </text>
    <text x="0" y="52" class="text-small" style="font-size: 13px; text-anchor: start;">
      PublicationType • Keywords • PMC_ID • MeSH_Terms • GrantInfo • Language • ISSN
    </text>
  </g>
  
  <!-- Tech stack -->
  <g transform="translate(50, 630)">
    <text x="0" y="0" class="text-white" style="font-size: 16px; text-anchor: start; font-weight: 600;">Libraries:</text>
    <text x="0" y="28" class="text-small" style="font-size: 13px; text-anchor: start;">
      requests • lxml (etree) • BeautifulSoup4 • csv • os
    </text>
  </g>
  
  <!-- Stats box -->
  <g transform="translate(1050, 420)">
    <rect x="0" y="0" width="500" height="230" rx="5" class="box" style="fill: #2C3E47;"/>
    <text x="250" y="35" class="text-white" style="font-size: 18px; font-weight: 600;">Pipeline Configuration</text>
    
    <text x="30" y="75" class="text-small" style="font-size: 15px; text-anchor: start; font-weight: 600;">API Endpoints:</text>
    <text x="30" y="103" class="text-small" style="font-size: 13px; text-anchor: start;">• ESearch: esearch.fcgi (PMID retrieval)</text>
    <text x="30" y="127" class="text-small" style="font-size: 13px; text-anchor: start;">• EFetch: efetch.fcgi (Full article metadata)</text>
    
    <text x="30" y="167" class="text-small" style="font-size: 15px; text-anchor: start; font-weight: 600;">Processing:</text>
    <text x="30" y="195" class="text-small" style="font-size: 13px; text-anchor: start;">• Batch Size: 200 PMIDs/request</text>
    <text x="30" y="219" class="text-small" style="font-size: 13px; text-anchor: start;">• Sort Order: Best Match (relevance)</text>
  </g>
</svg>